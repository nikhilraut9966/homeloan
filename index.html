<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HOME LOAN MAX SAVING CALCULATOR — Table + Bar Chart</title>
  <style>
    body{font-family:Arial;padding:18px;background:#f4f6f9}
    .card{background:white;padding:18px;border-radius:10px;max-width:980px;margin:18px auto;box-shadow:0 6px 24px rgba(10,20,40,0.06)}
    label{display:block;margin-top:10px;font-weight:600;color:#123}
    input,select,button{width:100%;padding:10px;margin-top:6px;font-size:14px;border-radius:6px;border:1px solid #dde6f4}
    .actions{display:flex;gap:10px;margin-top:12px}
    #output{margin-top:14px;padding:10px;background:#fbfdff;border-radius:8px;border:1px solid #e6f0ff}
    #debug{margin-top:10px;color:#c33;font-size:13px}
    .small{font-size:13px;color:#555}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #ddd;padding:6px;text-align:right;font-size:13px}
    th{background:#f7fafc;color:#111;font-weight:700;text-align:center}
    #barCanvas{width:100%;height:240px;margin-top:12px;background:white;border-radius:6px}
    .summary{margin-top:12px;font-weight:700}
  </style>
</head>
<body>
  <div class="card">
    <h2>HOME LOAN MAX SAVING CALCULATOR</h2>

    <label>Loan amount (₹)</label>
    <input id="loan" type="number" value="100000" />

    <label>Interest rate (% p.a.)</label>
    <input id="rate" type="number" step="0.01" value="7.7" />

    <label>Tenure (months)</label>
    <input id="months" type="number" value="12" />

    <label>Lump deposit at Day 1 (₹)</label>
    <input id="depositAmt" type="number" value="10000" />

    <div class="actions">
      <button id="calcBtn">Calculate</button>
      <button id="downloadBtn" style="background:#2a934a;color:#fff">Download CSV (with & without deposit)</button>
    </div>

    <div id="output" class="small">Results will appear here after you click <b>Calculate</b>.</div>
    <div id="debug" aria-live="polite"></div>

    <!-- table that shows the exact CSV/download data -->
    <div id="downloadDataContainer">
      <div style="margin-top:14px;font-weight:700">Downloaded data preview (exact CSV rows):</div>
      <div id="downloadTableWrap"></div>
    </div>

    <!-- bar chart showing interest comparison -->
    <div class="summary" id="interestSavedBox" style="display:none"></div>
    <canvas id="barCanvas"></canvas>
  </div>

<script>
(function(){
  function toNum(v){ v = Number(v); return isNaN(v)?0:v; }
  function fmtCurrency(v){ return '₹'+Number(v||0).toLocaleString('en-IN',{minimumFractionDigits:2, maximumFractionDigits:2}); }
  function fmtNumber2(v){ return Number(v).toFixed(2); }

  function calcEmi(P, annualRate, n){
    let r = annualRate/12/100;
    if(r===0) return P/n;
    return P * r * Math.pow(1+r,n) / (Math.pow(1+r,n)-1);
  }

  function generateSchedule(P,R,N,deposit){
    const emi = calcEmi(P,R,N);
    let outstanding = Math.max(0, P - (deposit||0));
    const monthlyRate = R/12/100;
    const schedule = [];
    for(let m=1; m<=N && outstanding>0.0001; m++){
      const initial = outstanding;
      const interest = initial * monthlyRate;
      let principalPaid = emi - interest;
      if(principalPaid > outstanding) principalPaid = outstanding;
      outstanding = Math.max(0, outstanding - principalPaid);
      schedule.push({
        month: m,
        initial: Number(initial),
        interest: Number(interest),
        emi: Number(emi),
        principalPaid: Number(principalPaid),
        deposit: (m===1? Number(deposit||0) : 0),
        outstanding: Number(outstanding)
      });
    }
    return schedule;
  }

  // Render HTML table that exactly mirrors CSV rows (rounded to 2 decimals)
  function renderDownloadTable(noS, wiS){
    const maxLen = Math.max(noS.length, wiS.length);
    const wrap = document.getElementById('downloadTableWrap');
    let html = '<table><thead>';
    // first header row: visually show No Deposit / With Deposit above blocks
    html += '<tr><th colspan="7" style="text-align:center">No Deposit</th><th colspan="6" style="text-align:center">With Deposit</th></tr>';
    // second header
    html += '<tr>';
    const headers = ['Month','Loan','Interest','EMI','Principal','Deposit','Outstanding','Loan','Interest','EMI','Principal','Deposit','Outstanding'];
    headers.forEach(h=> html += '<th>'+h+'</th>');
    html += '</tr></thead><tbody>';
    for(let i=0;i<maxLen;i++){
      const a = noS[i] || {initial:'', interest:'', emi:'', principalPaid:'', deposit:'', outstanding:''};
      const b = wiS[i] || {initial:'', interest:'', emi:'', principalPaid:'', deposit:'', outstanding:''};
      html += '<tr>';
      html += '<td style="text-align:center">'+(i+1)+'</td>';
      html += '<td>'+ (a.initial!==''? fmtNumber2(a.initial): '') +'</td>';
      html += '<td>'+ (a.interest!==''? fmtNumber2(a.interest): '') +'</td>';
      html += '<td>'+ (a.emi!==''? fmtNumber2(a.emi): '') +'</td>';
      html += '<td>'+ (a.principalPaid!==''? fmtNumber2(a.principalPaid): '') +'</td>';
      html += '<td>'+ (a.deposit!==''? fmtNumber2(a.deposit): '') +'</td>';
      html += '<td>'+ (a.outstanding!==''? fmtNumber2(a.outstanding): '') +'</td>';

      html += '<td>'+ (b.initial!==''? fmtNumber2(b.initial): '') +'</td>';
      html += '<td>'+ (b.interest!==''? fmtNumber2(b.interest): '') +'</td>';
      html += '<td>'+ (b.emi!==''? fmtNumber2(b.emi): '') +'</td>';
      html += '<td>'+ (b.principalPaid!==''? fmtNumber2(b.principalPaid): '') +'</td>';
      html += '<td>'+ (b.deposit!==''? fmtNumber2(b.deposit): '') +'</td>';
      html += '<td>'+ (b.outstanding!==''? fmtNumber2(b.outstanding): '') +'</td>';
      html += '</tr>';
    }
    html += '</tbody></table>';
    wrap.innerHTML = html;
  }

  // Draw a simple bar chart (two bars) showing interest amounts
  function drawBarChart(interestNo, interestWith){
    const canvas = document.getElementById('barCanvas');
    const ctx = canvas.getContext('2d');
    const w = canvas.clientWidth || 900;
    const h = canvas.clientHeight || 240;
    canvas.width = Math.floor(w * devicePixelRatio);
    canvas.height = Math.floor(h * devicePixelRatio);
    ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    ctx.clearRect(0,0,w,h);

    const values = [ interestNo, interestWith ];
    const labels = ['No Deposit','With Deposit'];
    const maxVal = Math.max(...values,1);
    const barWidth = Math.min(120, (w-100)/3);

    // axes
    ctx.strokeStyle = '#ddd'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(60,10); ctx.lineTo(60,h-40); ctx.lineTo(w-20,h-40); ctx.stroke();

    // y ticks
    ctx.fillStyle='#444'; ctx.font='12px Arial';
    for(let i=0;i<=4;i++){
      const y = 10 + (h-50) * (i/4);
      const val = Math.round(maxVal * (1 - i/4));
      ctx.fillText(val.toLocaleString('en-IN'), 8, y+4);
      ctx.strokeStyle='#f1f5f9'; ctx.beginPath(); ctx.moveTo(60,y); ctx.lineTo(w-20,y); ctx.stroke();
    }

    // bars
    const startX = 80;
    values.forEach((v,i)=>{
      const x = startX + i*(barWidth+60);
      const barHeight = (h-70) * (v / maxVal);
      const y = (h-40) - barHeight;
      ctx.fillStyle = (i===0? '#d9534f' : '#2a934a');
      ctx.fillRect(x, y, barWidth, barHeight);
      // value label above bar
      ctx.fillStyle='#000'; ctx.font='13px Arial';
      ctx.fillText(fmtNumber2(v), x + barWidth/2 - ctx.measureText(fmtNumber2(v)).width/2, y-6);
      // x label
      ctx.fillStyle='#000'; ctx.font='12px Arial';
      ctx.fillText(labels[i], x + barWidth/2 - ctx.measureText(labels[i]).width/2, h-18);
    });
  }

  function calculate(){
    try{
      document.getElementById('debug').textContent = '';
      const P = toNum(document.getElementById('loan').value);
      const R = toNum(document.getElementById('rate').value);
      const N = Math.max(1, Math.round(toNum(document.getElementById('months').value)));
      const D = toNum(document.getElementById('depositAmt').value);

      if(P <= 0){ document.getElementById('debug').textContent = 'Loan must be > 0'; return; }

      const emi = calcEmi(P,R,N);
      const schNo = generateSchedule(P,R,N,0);
      const schWith = generateSchedule(P,R,N,D);

      window.schedule_no = schNo;
      window.schedule_with = schWith;

      const interestNo = schNo.reduce((s,x)=>s + x.interest, 0);
      const interestWith = schWith.reduce((s,x)=>s + x.interest, 0);
      const saved = interestNo - interestWith;
      const reducedTenure = schWith.length;
      const firstIntNo = schNo[0] ? schNo[0].interest : 0;
      const firstIntWith = schWith[0] ? schWith[0].interest : 0;
      const effNo = (firstIntNo * 12 / P) * 100;
      const effWith = (firstIntWith * 12 / P) * 100;

      // display summary (rounded)
      document.getElementById('output').innerHTML =
        'EMI: <b>' + fmtCurrency(fmtNumber2(emi)) + '</b><br>' +
        'Interest (No deposit): <b>' + fmtCurrency(fmtNumber2(interestNo)) + '</b><br>' +
        'Interest (With deposit): <b>' + fmtCurrency(fmtNumber2(interestWith)) + '</b><br>' +
        '<b>Interest saved: ' + fmtCurrency(fmtNumber2(saved)) + '</b><br>' +
        'Loan closes in <b>' + reducedTenure + ' months</b> after deposit<br>' +
        'Effective ROI (No deposit): <b>' + fmtNumber2(effNo) + '%</b><br>' +
        'Effective ROI (With deposit): <b>' + fmtNumber2(effWith) + '%</b>';

      // render table & chart
      renderDownloadTable(schNo, schWith);
      document.getElementById('interestSavedBox').style.display = 'block';
      document.getElementById('interestSavedBox').textContent = 'Interest saved: ' + fmtCurrency(fmtNumber2(saved));
      drawBarChart(interestNo, interestWith);

    }catch(err){
      console.error(err);
      document.getElementById('debug').textContent = 'Calculation error: ' + err.message;
    }
  }

  function downloadCSV(){
    try{
      if(!window.schedule_no || !window.schedule_with){ document.getElementById('debug').textContent = 'Run Calculate first'; return; }
      const noS = window.schedule_no;
      const wiS = window.schedule_with;
      const maxLen = Math.max(noS.length, wiS.length);
      const rows = [];

      // single header row (not merged)
      rows.push(['Month','Loan','Interest','EMI','Principal','Deposit','Outstanding','Loan','Interest','EMI','Principal','Deposit','Outstanding'].join(','));

      for(let i=0;i<maxLen;i++){
        const a = noS[i] || {initial:'', interest:'', emi:'', principalPaid:'', deposit:'', outstanding:''};
        const b = wiS[i] || {initial:'', interest:'', emi:'', principalPaid:'', deposit:'', outstanding:''};
        const row = [
          i+1,
          a.initial!=='' ? fmtNumber2(a.initial) : '',
          a.interest!=='' ? fmtNumber2(a.interest) : '',
          a.emi!=='' ? fmtNumber2(a.emi) : '',
          a.principalPaid!=='' ? fmtNumber2(a.principalPaid) : '',
          a.deposit!=='' ? fmtNumber2(a.deposit) : '',
          a.outstanding!=='' ? fmtNumber2(a.outstanding) : '',
          b.initial!=='' ? fmtNumber2(b.initial) : '',
          b.interest!=='' ? fmtNumber2(b.interest) : '',
          b.emi!=='' ? fmtNumber2(b.emi) : '',
          b.principalPaid!=='' ? fmtNumber2(b.principalPaid) : '',
          b.deposit!=='' ? fmtNumber2(b.deposit) : '',
          b.outstanding!=='' ? fmtNumber2(b.outstanding) : ''
        ];
        rows.push(row.join(','));
      }

      const blob = new Blob([rows.join('\n')], {type: 'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'amortisation_comparison.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }catch(err){
      document.getElementById('debug').textContent = 'Download failed: ' + err.message;
    }
  }

  document.getElementById('calcBtn').addEventListener('click', calculate);
  document.getElementById('downloadBtn').addEventListener('click', downloadCSV);
  // initial run
  calculate();
})();
</script>
</body>
</html>
